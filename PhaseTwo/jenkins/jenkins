pipeline {
    agent any

    tools {
        maven "Maven 3.9.6"
        jdk 'Amazon Corretto JDK 17'
    }
    environment {
        PHASE_NUMBER = "PhaseTwo"
        WORK_DIR="/home/jenkins"
        REMOTE_DIR="$WORK_DIR/DIMEI_PROJECT"
        GITHUB_REPO="https://github.com/joaocampelo3/energy-consumption-monolithic-migration-decomposition.git"
        // MONOLITH
        BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/Monolithic/retailproject"
        MONOLITH_DIR="$REMOTE_DIR/$PHASE_NUMBER/Monolithic"
        // API GATEWAY
        API_GATEWAY_BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/APIGatewayApplication"
        API_GATEWAY_DIR="$REMOTE_DIR/$PHASE_NUMBER/APIGatewayApplication"
        // LOAD BALANCER
        LOAD_BALANCER_BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/LoadBalancerApplication"
        LOAD_BALANCER_DIR="$REMOTE_DIR/$PHASE_NUMBER/LoadBalancerApplication"
        // RABBITMQ
        RABBITMQ_BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/RabbitMQ"
        RABBITMQ_DIR="$REMOTE_DIR/$PHASE_NUMBER/RabbitMQ"
        // USER MICROSERVICE
        USER_MICROSERVICE_BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/Microservices/User/retailproject"
        USER_MICROSERVICE_DIR="$REMOTE_DIR/$PHASE_NUMBER/Microservices/User"
        // ITEMS MICROSERVICE
        ITEMS_MICROSERVICE_BUILD_DIR="$REMOTE_DIR/$PHASE_NUMBER/Microservices/Items/retailproject"
        ITEMS_MICROSERVICE_DIR="$REMOTE_DIR/$PHASE_NUMBER/Microservices/Items"
        // MONITORING VARIABLES
        MONITORING_CONFIG_DIR="$REMOTE_DIR/monitoring"
        MONITORING_DIR="$WORK_DIR/Monitoring"
        // KEPLER VARIABLES
        KEPLER_PROJ_PATH="$MONITORING_DIR/kepler"
        //GOLANG_HOME
        GOLANG_HOME = '/usr/local/go/bin'
        PATH = "${GOLANG_HOME}:${env.PATH}"
    }

    stages {
        stage('Remove Directories') {
            steps {
                parallel(
                    dimei: {
                        sh 'rm -rf $REMOTE_DIR'
                    }
                )
            }
        }
        
        stage('Git Clone') {
            steps {
                parallel(
                    dimei: {
                        // Clone GitHub repository
                        sh 'rm -rf $REMOTE_DIR'
                        sh 'git clone $GITHUB_REPO $REMOTE_DIR && chmod 777 -R $REMOTE_DIR'
                    }
                )
            }
        }

        stage('Kepler Setup') {
            steps {
                sh '''
                    sudo chmod 777 $KEPLER_PROJ_PATH -R
                    cd $KEPLER_PROJ_PATH
                    sudo make cluster-up VERSION=latest GRAFANA_ENABLE=true
                    sudo make deploy VERSION=latest GRAFANA_ENABLE=true
                '''
            }
        }
        
        stage('Build Monolith') {
            parallel {
                stage('Build Monolith') {
                    steps {
                        // Build the GitHub repository
                        sh 'cd $BUILD_DIR && mvn clean install -U'
                    }
                    post {
                        success {
                            dir("${BUILD_DIR}") {
                                jacoco()
                            }
                        }
                    }
                }
                stage('Build API Gateway') {
                    steps {
                        // Build the GitHub repository
                        sh 'cd $API_GATEWAY_BUILD_DIR && mvn clean install -U'
                    }
                    post {
                        success {
                            dir("${API_GATEWAY_BUILD_DIR}") {
                                jacoco()
                            }
                        }
                    }
                }
                stage('Build Load Balancer') {
                    steps {
                        // Build the GitHub repository
                        sh 'cd $LOAD_BALANCER_BUILD_DIR && mvn clean install -U'
                    }
                    post {
                        success {
                            dir("${LOAD_BALANCER_BUILD_DIR}") {
                                jacoco()
                            }
                        }
                    }
                }
                stage('Build User Microservice') {
                    steps {
                        // Build the GitHub repository
                        sh 'cd $USER_MICROSERVICE_BUILD_DIR && mvn clean install -U'
                    }
                    post {
                        success {
                            dir("${USER_MICROSERVICE_BUILD_DIR}") {
                                jacoco()
                            }
                        }
                    }
                }
                stage('Build Items Microservice') {
                    steps {
                        // Build the GitHub repository
                        sh 'cd $ITEMS_MICROSERVICE_BUILD_DIR && mvn clean install -U'
                    }
                    post {
                        success {
                            dir("${ITEMS_MICROSERVICE_BUILD_DIR}") {
                                jacoco()
                            }
                        }
                    }
                }
            }
        }
        
        stage('Startup RabbitMQ') {
            steps {
                sh 'chmod 777 $RABBITMQ_DIR -R && cd $RABBITMQ_DIR && sudo ./build.sh'
            }
        }
        
        stage('Startup API Gateway') {
            steps {
                sh 'chmod 777 $API_GATEWAY_DIR -R && cd $API_GATEWAY_DIR && sudo ./build.sh'
            }
        }
        
        stage('Startup Load Balancer') {
            steps {
                sh 'chmod 777 $LOAD_BALANCER_DIR -R && cd $LOAD_BALANCER_DIR && sudo ./build.sh'
            }
        }
        
        stage('Startup Services') {
            parallel {
                 stage('Startup Monolith') {
                    steps {
                        sh 'chmod 777 $MONOLITH_DIR -R && cd $MONOLITH_DIR && sudo ./build.sh'
                    }
                 }
                 stage('Startup User Microservice') {
                    steps {
                        sh 'chmod 777 $USER_MICROSERVICE_DIR -R && cd $USER_MICROSERVICE_DIR && sudo ./build.sh'
                    }
                 }
                 stage('Startup Items Microservice') {
                    steps {
                        sh 'chmod 777 $ITEMS_MICROSERVICE_DIR -R && cd $ITEMS_MICROSERVICE_DIR && sudo ./build.sh'
                    }
                 }
            }
        }
    }
}